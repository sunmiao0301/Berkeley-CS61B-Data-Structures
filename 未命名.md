<img src="https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20211014_10e319b4-2d00-11ec-9441-fa163eb4f6be.png" alt="img" style="zoom:200%;" />

图描述了Ceph如何定位一个文件应该存储在集群中的具体位置。这里假设需要保存一个名为File的文件，如果该文件大于4M，则会被切分为多个大小为4M（默认值）的object（最后一个可以小于4M），其id（即oid）依次为：File0，File1……每个oid会根据一个静态hash函数映射到一个PG。这样，就完成了从File到PG的映射过程，可以看出，该过程是静态的，不会随着集群的扩容、组件故障变化而改变。**但是PG只是逻辑单元（正因为PG是抽象的存储节点，它不会随着物理节点的加入或则离开而增加或减少，因此数据到PG的映射是稳定的。）**，真正存储数据的是OSD，而从PG到OSD的映射，即为CRUSH算法的所需要做的。

简单的说，CRUSH的作用就是，在当前集群状态和存储规则下，根据PGid计算出一个OSD列表。存储规则一般不会经常变化，而集群当前状态，则可能因磁盘损坏、节点宕机等时刻变化。当节点因宕机或者重启而离开或者加入集群时，对象映射的OSD列表随之变化，数据就会从旧的OSD上迁移到新的OSD，该过程都是自动完成的，无需人工干预。





当节点变化时，由于节点拓扑的变化，会影响少量分片数据进行迁移，如下图新节点加入是引起的数据迁移，通过良好的分配算法，可以得到很好的负载均衡和稳定性，CRUSH提供了Uniform、List、Tree、Straw四种分配算法。

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210416_089e1aba-9eb2-11eb-8149-00163e068ecd.png)

